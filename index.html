<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #0f172a; color: white; }
        .taxi-gold { background: #fbbf24; color: black; font-weight: bold; }
        .nav-active { border-bottom: 3px solid #fbbf24; color: #fbbf24; }
        input, select { background: #1e293b; color: white; border: 1px solid #334155; padding: 10px; border-radius: 8px; width: 100%; }
        .hidden { display: none; }
    </style>
</head>
<body class="p-4">

    <nav class="flex justify-between items-center bg-black p-4 rounded-xl mb-6 border border-yellow-500/30">
        <span class="text-yellow-500 font-bold">FLEET MASTER</span>
        <div class="flex gap-4">
            <button onclick="showModule('rev')" id="n-rev" class="nav-active">الإيرادات</button>
            <button onclick="showModule('car')" id="n-car">السيارات</button>
        </div>
    </nav>

    <div id="m-rev">
        <div class="flex justify-between mb-4">
            <h2 class="text-xl">سجل الإيرادات</h2>
            <button onclick="loadTable()" class="taxi-gold px-4 py-1 rounded">تحديث البيانات ↻</button>
        </div>

        <div class="bg-slate-800 p-6 rounded-2xl mb-6">
            <form id="f-Rev">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label>التاريخ</label><input type="date" name="date" id="d-date"></div>
                    <div><label>رقم السيارة</label><select name="carNo" id="car-select"><option>جاري التحميل...</option></select></div>
                    <div><label>السائق</label><select name="driverName" id="driver-select"><option>جاري التحميل...</option></select></div>
                    <div><label>المبلغ</label><input type="number" name="amount"></div>
                </div>
                <button type="button" onclick="saveData()" class="w-full taxi-gold mt-4 py-3 rounded-lg">حفظ الآن</button>
            </form>
        </div>

        <div class="bg-slate-800 rounded-2xl overflow-hidden">
            <table class="w-full text-right">
                <thead class="bg-slate-700">
                    <tr><th class="p-3">التاريخ</th><th class="p-3">السيارة</th><th class="p-3">المبلغ</th></tr>
                </thead>
                <tbody id="res-table">
                    <tr><td colspan="3" class="p-10 text-center">اضغط تحديث لإظهار البيانات</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycby71CCOLpaw-Ng2m4olE9YwtfMZHAMS4ooaw3MJm5vsUbWFysoFf2bbMLS7oZFRXndcpA/exec";

        // 1. جلب السائقين والسيارات للقوائم
        async function loadLists() {
            try {
                const resDrivers = await fetch(`${API}?action=getDrivers`);
                const drivers = await resDrivers.json();
                document.getElementById('driver-select').innerHTML = drivers.map(d => `<option value="${d}">${d}</option>`).join('');

                const resCars = await fetch(`${API}?action=getCars`);
                const cars = await resCars.json();
                document.getElementById('car-select').innerHTML = cars.map(c => `<option value="${c}">${c}</option>`).join('');
            } catch (e) {
                console.error("خطأ في القوائم:", e);
            }
        }

        // 2. جلب جدول البيانات
        async function loadTable() {
            const table = document.getElementById('res-table');
            table.innerHTML = '<tr><td colspan="3" class="p-5 text-center">جاري التحميل...</td></tr>';
            try {
                const res = await fetch(`${API}?action=getRevenues`);
                const data = await res.json();
                table.innerHTML = data.map(r => `
                    <tr class="border-b border-slate-700">
                        <td class="p-3">${r.date || r.Date || '-'}</td>
                        <td class="p-3">${r.carNo || r.Car_No || '-'}</td>
                        <td class="p-3 text-yellow-500">${r.amount || r.Amount || '-'}</td>
                    </tr>
                `).join('');
            } catch (e) {
                table.innerHTML = '<tr><td colspan="3" class="p-5 text-center text-red-400">فشل في جلب البيانات. تأكد من إعدادات السكريبت.</td></tr>';
            }
        }

        // 3. حفظ البيانات
        function saveData() {
            const form = document.getElementById('f-Rev');
            const formData = new FormData(form);
            const params = new URLSearchParams(formData);
            params.append('action', 'saveRevenue');

            fetch(API, { method: 'POST', mode: 'no-cors', body: params })
                .then(() => {
                    alert("تم الإرسال بنجاح!");
                    form.reset();
                    loadTable();
                });
        }

        window.onload = () => {
            document.getElementById('d-date').value = new Date().toISOString().split('T')[0];
            loadLists();
            loadTable();
        };
    </script>
</body>
</html>