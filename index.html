<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>نظام إدارة التاكسي - GitHub Version</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background: #f8f9fa; text-align: right; }
        .screen { display: none; padding: 20px; }
        .active { display: block; }
        .nav-card { cursor: pointer; border: none; border-radius: 15px; padding: 25px; color: white; transition: 0.3s; text-align: center; height: 100%; }
        .nav-card:hover { transform: translateY(-5px); filter: brightness(1.1); }
        .bg-income { background: linear-gradient(45deg, #2ecc71, #27ae60); }
        .bg-expense { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .bg-drivers { background: linear-gradient(45deg, #3498db, #2980b9); }
        .bg-cars { background: linear-gradient(45deg, #34495e, #2c3e50); }
        .bg-logs { background: linear-gradient(45deg, #f39c12, #d35400); }
        .bg-users { background: linear-gradient(45deg, #9b59b6, #8e44ad); }
        .bg-reports { background: linear-gradient(45deg, #7f8c8d, #2c3e50); }
    </style>
</head>
<body>

<div id="loginScreen" class="container mt-5 active">
    <div class="row justify-content-center">
        <div class="col-md-4 bg-white p-4 shadow rounded-4 text-center">
            <h2 class="mb-4">دخول النظام</h2>
            <input type="text" id="u" class="form-control mb-3" placeholder="اسم المستخدم">
            <input type="password" id="p" class="form-control mb-4" placeholder="كلمة المرور">
            <button onclick="login()" class="btn btn-dark w-100 py-2">تسجيل الدخول</button>
        </div>
    </div>
</div>

<div id="mainMenu" class="container mt-4 screen">
    <div class="alert alert-dark d-flex justify-content-between align-items-center rounded-4">
        <span><i class="fas fa-user"></i> المستخدم: <b id="userName"></b></span>
        <button class="btn btn-sm btn-danger" onclick="location.reload()">خروج</button>
    </div>
    
    <div class="row g-3">
        <div class="col-6 col-md-3"><div onclick="nav('incForm')" class="nav-card bg-income shadow">الإيراد</div></div>
        <div class="col-6 col-md-3"><div onclick="nav('expForm')" class="nav-card bg-expense shadow">المصروف</div></div>
        <div class="col-6 col-md-3"><div onclick="nav('logForm')" class="nav-card bg-logs shadow">تبديل السيارات</div></div>
        <div class="col-6 col-md-3"><div onclick="nav('drvForm')" class="nav-card bg-drivers shadow">السائقين</div></div>
        <div class="col-6 col-md-3"><div onclick="nav('carForm')" class="nav-card bg-cars shadow">السيارات</div></div>
        <div class="col-6 col-md-3"><div onclick="nav('usrForm')" class="nav-card bg-users shadow">المستخدمين</div></div>
        <div class="col-12 col-md-6"><div onclick="nav('repScreen')" class="nav-card bg-reports shadow">التقارير المالية</div></div>
    </div>
</div>

<div id="incForm" class="container mt-4 screen bg-white p-4 shadow rounded-4">
    <h3>تسجيل إيراد جديد</h3><hr>
    <div class="row g-3">
        <div class="col-md-6"><label>التاريخ</label><input type="date" id="inc_1" class="form-control"></div>
        <div class="col-md-6"><label>السيارة</label><select id="inc_2" class="form-select car-list"></select></div>
        <div class="col-md-6"><label>السائق</label><select id="inc_3" class="form-select drv-list"></select></div>
        <div class="col-md-6"><label>المبلغ</label><input type="number" id="inc_4" class="form-control"></div>
    </div>
    <div class="mt-4">
        <button onclick="save('Transactions', ['inc_1','inc_2','inc_3','inc_4'])" class="btn btn-success px-5">حفظ</button>
        <button onclick="nav('mainMenu')" class="btn btn-secondary px-5">رجوع</button>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbxUe0Jv4xMskktEoabi1NFI9JR2YB7UWVWNWE3CNSKowKLYGAabgDc5Xrrd8TQmTjXs/exec"; // استبدل هذا بالرابط الذي حصلت عليه من جوجل
    let LOGGED_USER = "";

    function nav(id) {
        document.querySelectorAll('.screen, #loginScreen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    async function login() {
        const u = document.getElementById('u').value;
        const p = document.getElementById('p').value;
        const res = await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'login', data: {u, p} }) });
        const json = await res.json();
        if(json.status === "success") {
            LOGGED_USER = json.user;
            document.getElementById('userName').innerText = LOGGED_USER;
            nav('mainMenu');
            loadOptions();
        } else { alert(json.msg); }
    }

    async function loadOptions() {
        const res = await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'getData' }) });
        const json = await res.json();
        const cars = json.cars.map(c => `<option value="${c}">${c}</option>`).join('');
        const drvs = json.drivers.map(d => `<option value="${d}">${d}</option>`).join('');
        document.querySelectorAll('.car-list').forEach(s => s.innerHTML = cars);
        document.querySelectorAll('.drv-list').forEach(s => s.innerHTML = drvs);
    }

    async function save(sheetName, fieldIds) {
        const rowData = fieldIds.map(id => document.getElementById(id).value);
        rowData.push(LOGGED_USER); // إضافة اسم المستخدم (Log)
        const res = await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'save', data: {sheetName, rowData} }) });
        const json = await res.json();
        alert(json.msg);
        nav('mainMenu');
    }
</script>
</body>
</html>