<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الإيرادات | Fleet Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        .tab-active { border-bottom: 4px solid #2563eb; color: #2563eb; background-color: #eff6ff; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="pb-10">

    <nav class="bg-white shadow-sm border-b mb-8 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 flex justify-between h-16 items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-chart-line text-blue-600 text-2xl"></i>
                <span class="text-xl font-bold text-gray-800">إدارة الأسطول</span>
            </div>
            <div class="text-sm font-medium text-blue-600 bg-blue-50 px-4 py-2 rounded-full">قسم الإيرادات</div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4">
        
        <div class="flex mb-8 bg-white rounded-2xl shadow-sm border p-1 overflow-hidden">
            <button onclick="switchTab('add')" id="tabAdd" class="flex-1 py-4 text-center font-bold tab-active transition-all rounded-xl">
                <i class="fas fa-plus-circle ml-2"></i> إضافة إيراد
            </button>
            <button onclick="switchTab('edit')" id="tabEdit" class="flex-1 py-4 text-center font-bold text-gray-400 transition-all rounded-xl">
                <i class="fas fa-history ml-2"></i> السجلات السابقة
            </button>
        </div>

        <div id="addContainer" class="space-y-6">
            <div class="bg-white rounded-3xl shadow-xl border overflow-hidden">
                <form id="revenueForm" class="p-6 md:p-10 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="hidden" name="id" id="recordId">
                    
                    <div class="col-span-1">
                        <label class="block text-sm font-bold text-gray-700 mb-2">التاريخ</label>
                        <input type="date" name="date" id="inputDate" required class="w-full border-2 border-gray-100 p-3 rounded-xl focus:border-blue-500 outline-none bg-gray-50">
                    </div>

                    <div class="col-span-1">
                        <label class="block text-sm font-bold text-gray-700 mb-2">رقم السيارة (من العمود 2)</label>
                        <select id="carList" name="carNo" required class="w-full border-2 border-gray-100 p-3 rounded-xl focus:border-blue-500 outline-none bg-gray-50"></select>
                    </div>

                    <div class="col-span-1">
                        <label class="block text-sm font-bold text-gray-700 mb-2">اسم السائق (من العمود 2)</label>
                        <select id="driverList" name="driverName" required class="w-full border-2 border-gray-100 p-3 rounded-xl focus:border-blue-500 outline-none bg-gray-50"></select>
                    </div>

                    <div class="col-span-1">
                        <label class="block text-sm font-bold text-gray-700 mb-2">الفئة</label>
                        <select name="category" required class="w-full border-2 border-gray-100 p-3 rounded-xl focus:border-blue-500 outline-none bg-gray-50">
                            <option value="ضمان">ضمان</option>
                            <option value="مخالفات">مخالفات</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                    </div>

                    <div class="col-span-1">
                        <label class="block text-sm font-bold text-gray-700 mb-2">المبلغ (JD)</label>
                        <input type="number" step="0.01" name="amount" required placeholder="0.00" class="w-full border-2 border-gray-100 p-3 rounded-xl focus:border-blue-500 outline-none bg-gray-50">
                    </div>

                    <div class="col-span-1">
                        <label class="block text-sm font-bold text-gray-700 mb-2">طريقة الدفع</label>
                        <select name="method" required class="w-full border-2 border-gray-100 p-3 rounded-xl focus:border-blue-500 outline-none bg-gray-50">
                            <option value="Cash">Cash</option>
                            <option value="Cliq">Cliq</option>
                            <option value="Transfer">Transfer</option>
                            <option value="Bank">Bank</option>
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ملاحظات</label>
                        <textarea name="notes" rows="2" class="w-full border-2 border-gray-100 p-3 rounded-xl focus:border-blue-500 outline-none bg-gray-50"></textarea>
                    </div>

                    <button type="submit" id="submitBtn" class="md:col-span-2 bg-blue-600 text-white font-bold py-4 rounded-2xl hover:bg-blue-700 transition-all shadow-lg hover:shadow-blue-200">
                        حفظ البيانات
                    </button>
                </form>
            </div>
        </div>

        <div id="editContainer" class="hidden">
            <div class="bg-white rounded-3xl shadow-xl border overflow-hidden">
                <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                    <h3 class="font-bold text-gray-700">سجل الإيرادات</h3>
                    <button onclick="loadTableData()" class="text-blue-600 p-2 hover:bg-blue-50 rounded-full transition">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead>
                            <tr class="bg-gray-50 text-gray-500 text-xs uppercase">
                                <th class="p-4 border-b">التاريخ</th>
                                <th class="p-4 border-b">السيارة</th>
                                <th class="p-4 border-b">السائق</th>
                                <th class="p-4 border-b text-center">المبلغ</th>
                                <th class="p-4 border-b text-center">تعديل</th>
                            </tr>
                        </thead>
                        <tbody id="revenueTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // استبدل هذا بالرابط الخاص بك
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxWcW9uabODjpEqAjIuc4A8nOn0kLNInvaSukiyW20S-nBwZDtX1YI42wjJZEpNFzT7/exec";

        window.onload = function() {
            document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
            fetchInitialData();
        };

        function switchTab(tab) {
            const add = document.getElementById('addContainer');
            const edit = document.getElementById('editContainer');
            const btnAdd = document.getElementById('tabAdd');
            const btnEdit = document.getElementById('tabEdit');

            if(tab === 'add') {
                add.style.display = 'block';
                edit.style.display = 'none';
                btnAdd.className = "flex-1 py-4 text-center font-bold tab-active transition-all rounded-xl";
                btnEdit.className = "flex-1 py-4 text-center font-bold text-gray-400 transition-all rounded-xl";
            } else {
                add.style.display = 'none';
                edit.style.display = 'block';
                btnEdit.className = "flex-1 py-4 text-center font-bold tab-active transition-all rounded-xl";
                btnAdd.className = "flex-1 py-4 text-center font-bold text-gray-400 transition-all rounded-xl";
                loadTableData();
            }
        }

        async function fetchInitialData() {
            try {
                const [dRes, cRes] = await Promise.all([
                    fetch(SCRIPT_URL + "?action=getDrivers"),
                    fetch(SCRIPT_URL + "?action=getCars")
                ]);
                const drivers = await dRes.json();
                const cars = await cRes.json();

                document.getElementById('driverList').innerHTML = '<option value="">اختر السائق...</option>' + 
                    drivers.map(d => `<option value="${d}">${d}</option>`).join('');
                
                document.getElementById('carList').innerHTML = '<option value="">اختر السيارة...</option>' + 
                    cars.map(c => `<option value="${c}">${c}</option>`).join('');
            } catch (e) { console.error("Error loading lists"); }
        }

        async function loadTableData() {
            const tbody = document.getElementById('revenueTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center p-10 text-gray-400 italic font-medium">جاري تحديث السجلات...</td></tr>';
            
            try {
                const res = await fetch(SCRIPT_URL + "?action=getRevenues");
                const data = await res.json();
                
                tbody.innerHTML = data.map(row => `
                    <tr class="hover:bg-gray-50 border-b border-gray-100 transition-colors">
                        <td class="p-4 text-sm font-medium">${row.date}</td>
                        <td class="p-4 font-bold text-blue-700">${row.carNo}</td>
                        <td class="p-4 text-sm text-gray-600">${row.driverName}</td>
                        <td class="p-4 text-center font-bold text-green-600">${row.amount} JD</td>
                        <td class="p-4 text-center">
                            <button onclick='editRecord(${JSON.stringify(row)})' class="bg-blue-50 text-blue-600 p-2 rounded-lg hover:bg-blue-600 hover:text-white transition">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) { tbody.innerHTML = '<tr><td colspan="5" class="text-center p-10 text-red-500">حدث خطأ في جلب البيانات</td></tr>'; }
        }

        function editRecord(data) {
            switchTab('add');
            const form = document.getElementById('revenueForm');
            form.recordId.value = data.id;
            form.date.value = data.date;
            form.carNo.value = data.carNo;
            form.driverName.value = data.driverName;
            form.category.value = data.category;
            form.amount.value = data.amount;
            form.method.value = data.method;
            form.notes.value = data.notes;
            
            document.getElementById('submitBtn').innerText = "تحديث البيانات الحالية";
            document.getElementById('submitBtn').classList.replace('bg-blue-600', 'bg-orange-500');
        }

        document.getElementById('revenueForm').onsubmit = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "جاري المعالجة...";

            const params = new URLSearchParams(new FormData(this));
            params.append('action', 'saveRevenue');
            params.append('collector', 'Admin_System');

            try {
                await fetch(SCRIPT_URL + "?" + params.toString(), { method: 'POST' });
                alert("تمت العملية بنجاح!");
                this.reset();
                document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
                btn.innerText = "حفظ البيانات";
                btn.classList.replace('bg-orange-500', 'bg-blue-600');
            } catch (e) { alert("خطأ في الاتصال بالسيرفر"); }
            btn.disabled = false;
        };
    </script>
</body>
</html>