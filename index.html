<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الأسطول الشامل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        .tab-active { border-bottom: 4px solid #2563eb; color: #2563eb; background-color: #eff6ff; }
        .nav-btn-active { background-color: #2563eb; color: white; }
        .hidden { display: none; }
    </style>
</head>
<body class="pb-10">

    <nav class="bg-white shadow-sm border-b mb-8 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 flex justify-between h-16 items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-truck-monster text-blue-600 text-2xl"></i>
                <span class="text-xl font-bold text-gray-800">أسطول النقل</span>
            </div>
            <div class="flex gap-2">
                <button onclick="switchMainModule('revenues')" id="navRev" class="nav-btn-active px-4 py-2 rounded-lg font-bold transition">الإيرادات</button>
                <button onclick="switchMainModule('expenses')" id="navExp" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-bold transition">المصاريف</button>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4">
        
        <div id="moduleRevenues">
            <div class="flex mb-6 bg-white rounded-2xl shadow-sm border p-1 overflow-hidden">
                <button onclick="switchTab('add', 'Rev')" id="tabAddRev" class="flex-1 py-3 text-center font-bold tab-active rounded-xl">إضافة إيراد</button>
                <button onclick="switchTab('list', 'Rev')" id="tabListRev" class="flex-1 py-3 text-center font-bold text-gray-400 rounded-xl">سجل الإيرادات</button>
            </div>
            
            <div id="containerAddRev" class="bg-white rounded-3xl shadow-xl border p-6 md:p-8">
                <form id="revenueForm" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <input type="hidden" name="id">
                    <div><label class="block text-sm font-bold mb-1">التاريخ</label><input type="date" name="date" required class="w-full border p-3 rounded-xl bg-gray-50 outline-none focus:border-blue-500"></div>
                    <div><label class="block text-sm font-bold mb-1">رقم السيارة</label><select name="carNo" class="carList w-full border p-3 rounded-xl bg-gray-50 outline-none focus:border-blue-500"></select></div>
                    <div><label class="block text-sm font-bold mb-1">اسم السائق</label><select name="driverName" class="driverList w-full border p-3 rounded-xl bg-gray-50 outline-none focus:border-blue-500"></select></div>
                    <div><label class="block text-sm font-bold mb-1">الفئة</label><select name="category" class="w-full border p-3 rounded-xl bg-gray-50 outline-none"><option>ضمان</option><option>مخالفات</option><option>أخرى</option></select></div>
                    <div><label class="block text-sm font-bold mb-1">المبلغ (JD)</label><input type="number" step="0.01" name="amount" required class="w-full border p-3 rounded-xl bg-gray-50 outline-none"></div>
                    <div><label class="block text-sm font-bold mb-1">طريقة الدفع</label><select name="method" class="w-full border p-3 rounded-xl bg-gray-50 outline-none"><option>Cash</option><option>Cliq</option><option>Transfer</option></select></div>
                    <div class="md:col-span-2"><label class="block text-sm font-bold mb-1">ملاحظات</label><textarea name="notes" class="w-full border p-3 rounded-xl bg-gray-50 outline-none"></textarea></div>
                    <button type="submit" class="md:col-span-2 bg-blue-600 text-white font-bold py-4 rounded-2xl hover:bg-blue-700 shadow-lg">حفظ الإيراد</button>
                </form>
            </div>

            <div id="containerListRev" class="hidden bg-white rounded-3xl shadow-xl border overflow-hidden">
                <table class="w-full text-right"><thead class="bg-gray-50 text-xs text-gray-500"><tr><th class="p-4">التاريخ</th><th class="p-4">السيارة</th><th class="p-4">المبلغ</th><th class="p-4 text-center">إجراء</th></tr></thead><tbody id="tableRev"></tbody></table>
            </div>
        </div>

        <div id="moduleExpenses" class="hidden">
            <div class="flex mb-6 bg-white rounded-2xl shadow-sm border p-1 overflow-hidden">
                <button onclick="switchTab('add', 'Exp')" id="tabAddExp" class="flex-1 py-3 text-center font-bold tab-active rounded-xl">إضافة مصروف</button>
                <button onclick="switchTab('list', 'Exp')" id="tabListExp" class="flex-1 py-3 text-center font-bold text-gray-400 rounded-xl">سجل المصاريف</button>
            </div>

            <div id="containerAddExp" class="bg-white rounded-3xl shadow-xl border p-6 md:p-8">
                <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <input type="hidden" name="id">
                    <div><label class="block text-sm font-bold mb-1">التاريخ</label><input type="date" name="date" required class="w-full border p-3 rounded-xl bg-gray-50 outline-none focus:border-red-500"></div>
                    <div><label class="block text-sm font-bold mb-1">المبلغ (JD)</label><input type="number" step="0.01" name="amount" required class="w-full border p-3 rounded-xl bg-gray-50 outline-none focus:border-red-500"></div>
                    <div><label class="block text-sm font-bold mb-1">السيارة (من B)</label><select name="car" class="carList w-full border p-3 rounded-xl bg-gray-50 outline-none"></select></div>
                    <div><label class="block text-sm font-bold mb-1">السائق (من B)</label><select name="driver" class="driverList w-full border p-3 rounded-xl bg-gray-50 outline-none"></select></div>
                    <div><label class="block text-sm font-bold mb-1">البائع</label><input type="text" name="vendor" required class="w-full border p-3 rounded-xl bg-gray-50 outline-none"></div>
                    <div><label class="block text-sm font-bold mb-1">المسؤول</label><input type="text" name="admin" value="Admin_Logged_In" readonly class="w-full border p-3 rounded-xl bg-gray-100 outline-none text-gray-500"></div>
                    <div class="md:col-span-2"><label class="block text-sm font-bold mb-1">ملاحظات</label><textarea name="notes" class="w-full border p-3 rounded-xl bg-gray-50 outline-none"></textarea></div>
                    <button type="submit" class="md:col-span-2 bg-red-600 text-white font-bold py-4 rounded-2xl hover:bg-red-700 shadow-lg transition">حفظ المصروف</button>
                </form>
            </div>

            <div id="containerListExp" class="hidden bg-white rounded-3xl shadow-xl border overflow-hidden">
                <table class="w-full text-right"><thead class="bg-gray-50 text-xs text-gray-500"><tr><th class="p-4">التاريخ</th><th class="p-4">السيارة</th><th class="p-4">المبلغ</th><th class="p-4">البائع</th><th class="p-4 text-center">إجراء</th></tr></thead><tbody id="tableExp"></tbody></table>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxWcW9uabODjpEqAjIuc4A8nOn0kLNInvaSukiyW20S-nBwZDtX1YI42wjJZEpNFzT7/exec";

        window.onload = function() {
            document.querySelectorAll('input[type="date"]').forEach(i => i.value = new Date().toISOString().split('T')[0]);
            loadLists();
        };

        function switchMainModule(mod) {
            document.getElementById('moduleRevenues').classList.toggle('hidden', mod !== 'revenues');
            document.getElementById('moduleExpenses').classList.toggle('hidden', mod !== 'expenses');
            document.getElementById('navRev').className = mod === 'revenues' ? 'nav-btn-active px-4 py-2 rounded-lg font-bold shadow-md' : 'bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-bold';
            document.getElementById('navExp').className = mod === 'expenses' ? 'nav-btn-active px-4 py-2 rounded-lg font-bold shadow-md' : 'bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-bold';
        }

        function switchTab(type, mod) {
            const isAdd = type === 'add';
            document.getElementById(`containerAdd${mod}`).classList.toggle('hidden', !isAdd);
            document.getElementById(`containerList${mod}`).classList.toggle('hidden', isAdd);
            document.getElementById(`tabAdd${mod}`).className = isAdd ? "flex-1 py-3 text-center font-bold tab-active rounded-xl" : "flex-1 py-3 text-center font-bold text-gray-400 rounded-xl";
            document.getElementById(`tabList${mod}`).className = !isAdd ? "flex-1 py-3 text-center font-bold tab-active rounded-xl" : "flex-1 py-3 text-center font-bold text-gray-400 rounded-xl";
            if(!isAdd) mod === 'Rev' ? loadTableData('getRevenues', 'tableRev') : loadTableData('getExpenses', 'tableExp');
        }

        async function loadLists() {
            const [dRes, cRes] = await Promise.all([fetch(SCRIPT_URL+"?action=getDrivers"), fetch(SCRIPT_URL+"?action=getCars")]);
            const drivers = await dRes.json(); const cars = await cRes.json();
            const dOptions = '<option value="">اختر...</option>' + drivers.map(d => `<option value="${d}">${d}</option>`).join('');
            const cOptions = '<option value="">اختر...</option>' + cars.map(c => `<option value="${c}">${c}</option>`).join('');
            document.querySelectorAll('.driverList').forEach(s => s.innerHTML = dOptions);
            document.querySelectorAll('.carList').forEach(s => s.innerHTML = cOptions);
        }

        async function loadTableData(action, tableId) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-gray-400 italic">جاري التحديث...</td></tr>';
            const res = await fetch(`${SCRIPT_URL}?action=${action}`);
            const data = await res.json();
            tbody.innerHTML = data.map(row => `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="p-4 text-sm">${row.date}</td>
                    <td class="p-4 font-bold text-gray-700">${row.carNo || row.car}</td>
                    <td class="p-4 font-bold ${action === 'getRevenues' ? 'text-green-600' : 'text-red-600'}">${row.amount} JD</td>
                    ${action === 'getExpenses' ? `<td class="p-4 text-sm">${row.vendor}</td>` : ''}
                    <td class="p-4 text-center">
                        <button onclick='editRecord(${JSON.stringify(row)}, "${action === 'getRevenues' ? 'Rev' : 'Exp'}")' class="text-blue-600 p-2 hover:bg-blue-100 rounded-lg"><i class="fas fa-edit"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function editRecord(data, mod) {
            switchTab('add', mod);
            const form = document.getElementById(mod === 'Rev' ? 'revenueForm' : 'expenseForm');
            Object.keys(data).forEach(key => { if(form[key]) form[key].value = data[key]; });
        }

        document.querySelectorAll('form').forEach(form => {
            form.onsubmit = async function(e) {
                e.preventDefault();
                const btn = this.querySelector('button[type="submit"]');
                const originalText = btn.innerText;
                btn.disabled = true; btn.innerText = "جاري الحفظ...";
                const params = new URLSearchParams(new FormData(this));
                params.append('action', this.id === 'revenueForm' ? 'saveRevenue' : 'saveExpense');
                params.append('collector', 'Admin'); // Default for now
                try {
                    await fetch(SCRIPT_URL + "?" + params.toString(), { method: 'POST' });
                    alert("تم الحفظ!"); this.reset();
                    if(this.id === 'revenueForm') switchTab('list', 'Rev'); else switchTab('list', 'Exp');
                } catch(e) { alert("خطأ!"); }
                btn.disabled = false; btn.innerText = originalText;
            };
        });
    </script>
</body>
</html>